?
: &usenextbuild
  resources:
  - file: build.yml
    content: |
      #!/bin/sh
      set eux
      mv nextbuild.yml > build.yml

?
: &getgit
  resources:
  - file: getgit.sh
    content: |
      #!/bin/sh
      set eux
      URL=$(yq -r '.source' /config.yml)
      git clone --recursive "$URL" $(pwd)
  - <<: &usenextbuild
  - file: nextbuild.yml
    content:
      command: sh getgit.sh

?
: &getcontainer
  resources:
  - file: getcontainer.sh
    content: |
      #!/bin/sh
      set eux
      CONTAINER=$(yq -r '.source' config.yml )
      docker pull "$CONTAINER"
      docker save "$CONTAINER" | undocker -o $(pwd)
  - <<: &usenextbuild
  - file: nextbuild.yml
    content:
      command: sh getcontainer.sh

?
: &runincontainer
  resources:
  - resources:
    - <<: *getgit
    - file: config.yml
      content:
        source: https://github.com/containerrepo.git
    - file: outputs.yml
      content:
      - everything but config.yml and build.yml
    path: /
  - <<: &usenextbuild
  - file: nextbuild.yml
    content:
      command: sh runincontainer.sh

---

resources:
- name: source-repo
  resources:
    - <<: *gittask
    - file: config.yml
      content:
        source: https://github.com/mysourcerepo
- name: mycontainer
  resources:
    - <<: *getcontainer
    - file: config.yml
      content:
        source: archlinux:base-devel
- name: main.o
  resources:
  - name: mycontainer
  - <<: *runincontainer
  - name: source-repo
    path: /src/
  - file: config.yml
    content:
      command: cd /src ; g++ -c main.cpp -o main.o
  - file: outputs.yaml
    content:
      - /src/main.o
- name: executable
  resources:
  - name: mycontainer
  - <<: *runincontainer
  - name: main.o
    path: /src
  - file: config.yml
    content:
      command: cd /src ; g++ main.o -o main
  - file: outputs.yaml
    content:
      - /src/main
